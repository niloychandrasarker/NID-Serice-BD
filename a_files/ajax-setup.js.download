$(document).ready(function() {
    var StatusCode = { SUCCESS: "SUCCESS", ERROR: "ERROR", PENDING: "PENDING"};
    var ContentType = {html: 'text/html', json: 'application/json'};
    $(document).ajaxStart(function() {
        if (window.showLoadingEnabled) {
            $(".ui.popup").remove();
            $("#container").mask(window.loadingMessage);
        }
    });
    $(document).ajaxSend(function(event, jqxhr) {
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        jqxhr.setRequestHeader(header, token);
    });
    $(document).ajaxComplete(function(event, jqxhr) {
        if(jqxhr.readyState === 0) return;
        var contentType = jqxhr.getResponseHeader("Content-Type");
        if(contentType.indexOf(ContentType.json) > -1) {
            var response = JSON.parse(jqxhr.responseText);
            if(response.status != StatusCode.PENDING && $.active <= 1) {
                if (window.showLoadingEnabled) {
                    $(".ui.popup").remove();
                    $("#container").unmask();
                }
            }
        }
        if(contentType.indexOf(ContentType.html) > -1) {
            if($.active <= 1) {
                if (window.showLoadingEnabled) {
                    $(".ui.popup").remove();
                    $("#container").unmask();
                }
            }
        }
        window.showLoadingEnabled = true;
    });
    $(document).ajaxError(function(event, jqxhr, settings) {
        if(jqxhr.readyState === 0 ) {
            noty({
                layout: 'bottomLeft',
                theme: 'noty_theme_default',
                type: 'error',
                text: window.error['networkConnection'],
                timeout: false
            });
            return;
        }
        if(settings.url.indexOf("login") === -1) {
            var errorCode = String(jqxhr.status);
            switch(errorCode) {
                case "302":
                    window.location = window.contextPath + "/?session-expired=true";
                    break;
                case "401":
                    window.location = window.contextPath + "/?session-expired=true";
                    break;
                case "500":
                    noty({
                        layout: 'bottomLeft',
                        theme: 'noty_theme_default',
                        type: 'error',
                        text: window.error['500'],
                        timeout: false
                    });
                    break;
                default:
                    var message = window.error[errorCode];
                    if (!message) {
                        noty({
                            layout: 'bottomLeft',
                            theme: 'noty_theme_default',
                            type: 'error',
                            text: window.error['unknown'],
                            timeout: false
                        });
                    } else {
                        var $errorBlock = $("#error-block");
                        if ($errorBlock.length <= 0) {
                            noty({
                                layout: 'bottomLeft',
                                theme: 'noty_theme_default',
                                type: 'error',
                                text: message,
                                timeout: false
                            });
                        } else {
                            $errorBlock.addClass("error").show().find("ul > li").text(message);
                        }
                    }
            }
        }
        window.showLoadingEnabled = true;
    });
});
